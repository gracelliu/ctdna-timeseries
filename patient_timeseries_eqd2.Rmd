---
title: "patient_timeseries_eqd2.rmd"
author: "Grace Liu"
date: "2024-07-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r load, include=FALSE}

library(data.table)
library(dplyr)
library(patchwork)
library(faraway)
library(ggExtra)
library(GGally)
library(ggsci)
library(ggplot2)
library(ggpubr)
library(ggthemr)
library(gridExtra)
library(gt)
library(gtsummary)
library(rlang)
library(scales)
library(survival)
library(survminer)
library(readxl)
library(reshape2)
library(tidyverse)
library(rmdformats)
library(prettydoc)
library(hrbrthemes)
library(tint)
library(tufte)
library(cowplot)

ggthemr("fresh")

load("/Users/graceliu/bratman/timeseries/data/2024-06-21_head-neck-dataframes.Rdata")
load('/Users/graceliu/bratman/timeseries/data/HPV_analysis_dataframes.Rdata')

```



```{r preprocessing, echo=FALSE}

df_patient_timeseries_eqd2 <- merge(
  df_ctdna_eqd2_radiomic_clinical %>% select(patient, timepoint, EQD2, gtv_primary, sum_gtv_nodes),
  df_hpvseq %>% select(patient, timepoint, seq_copies_mL),
  by = c("patient", "timepoint")) %>%
  # filter(timepoint != "3 months") %>%
  mutate(log_seq_copies_mL = log1p(seq_copies_mL))

df_airvolume = merge(df_cbctfate_smooth, df_clinical_opc, by="Mrn")

```


```{r HN2976, echo=FALSE}

# HPV ctDNA concentration 
ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = seq_copies_mL)) +
  geom_point() +
  geom_line() +
  labs(title = "seq_copies_mL vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "seq_copies_mL")

# HPV ctDNA concentration LOG 
ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = log_seq_copies_mL)) +
  geom_point() +
  geom_line() +
  labs(title = "log_seq_copies_mL vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "log_seq_copies_mL ")

# Volume of primary
p1 <- ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = gtv_primary)) +
  geom_line() +
  labs(title = "gtv_primary vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "gtv_primary")

# Volume of nodes
p2 <- ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = sum_gtv_nodes)) +
  geom_line() +
  labs(title = "Volumes vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "sum_gtv_nodes")

# Volume of air 
p3 <- ggplot(df_airvolume %>% filter(patient == "HN2976" & Roi =="x_Air_GTVp_Expanded05"), aes(x = fraction, y = smoothed_normalized)) + 
  geom_line() + 
  labs(title = "Volumes vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "sum_gtv_nodes")

# Overlaid as one graph (using cowplot)
ggdraw() +
  draw_plot(p1) +
  draw_plot(p2) +
  draw_plot(p3)

```


```{r}
df_cbctfate %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line(size=0.1) +
  facet_wrap(~Roi)

df_cbctfate %>%
  filter(Roi == 'x_GTVp_Tracking') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line() 


df_cbctfate %>%
  filter(Roi == 'x_GTVp_Tracking', cohort == 'OPC') %>%
  group_by(Mrn) %>%
  filter(fraction == max(fraction)) %>%
  ungroup() %>%
  arrange(percent_vol) %>%
  mutate(group = if_else(percent_vol < median(percent_vol), 'Below median', 'Above median'))


df_ctdna_collectiondates %>% 
  rename(Baseline = date_ctdna_baseline) %>% 
  gather(timepoint, date_ctdna, -patient) %>% 
  left_join(df_cbctfate, by = c('date_ctdna' = 'ExamDate'))
```



```{r}

df_ctdna_collectiondates_long <- df_ctdna_collectiondates %>% rename(baseline = date_ctdna_baseline,
                                    early = date_ctdna_early, 
                                    mid = date_ctdna_mid,
                                    followup = date_ctdna_followup) %>%
  gather(timepoint, date_ctdna, -patient)

```



```{r}

# Find common patients between df_hpvseq and df_ctdna_collectiondates
common_patients <- intersect(df_hpvseq$patient, df_ctdna_collectiondates$patient)
# Count common patients
common_count <- length(common_patients)

# Find patients only in df_hpvseq
only_in_hpvseq <- setdiff(df_hpvseq$patient, df_ctdna_collectiondates$patient)
# Count patients only in df_hpvseq
only_in_hpvseq_count <- length(only_in_hpvseq)

# Find patients only in df_ctdna_collectiondates
only_in_ctdna_collection_dates <- setdiff(df_ctdna_collectiondates$patient, df_hpvseq$patient)
# Count patients only in df_ctdna_collectiondates
only_in_ctdna_collection_dates_count <- length(only_in_ctdna_collection_dates)

# Display results
common_count
only_in_hpvseq_count
only_in_ctdna_collection_dates_count

```


```{r}

df_cbctvolume = inner_join(df_cbctfate, df_clinical_opc, by="Mrn")
unique(df_cbctvolume$cohort)
unique(df_cbctvolume$Roi)
unique(df_cbctvolume$series_index)


```

```{r}

# Find patients only in df_hpvseq
only_in_hpvseq <- setdiff(df_hpvseq$patient, df_cbctvolume$patient)
# Count patients only in df_hpvseq
only_in_hpvseq_count <- length(only_in_hpvseq)

# Find patients only in df_cbctvolume
only_in_cbctvolume <- setdiff(df_cbctvolume$patient, df_hpvseq$patient)
# Count patients only in df_cbctvolume
only_in_cbctvolume_count <- length(only_in_cbctvolume)

# Display the results
common_count
only_in_hpvseq_count
only_in_cbctvolume_count

```




```{r}

df_cbctfate %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line(size=0.1) +
  facet_wrap(~Roi)

df_cbctvolume %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.1) +
  facet_wrap(~Roi)

```


```{r}

# All patients air volume and tumor volume 

df_cbctvolume %>%
  filter(Roi == 'x_GTVp_Tracking') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Volume of Primary Tumor over the course of treatment for all patients",
       x = "fraction",
       y = "Volume of Primary Tumor")

df_cbctvolume %>%
  filter(Roi == 'x_Air_GTVp_Expanded05') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Air Volume in Primary Tumor over course of treatment for all patients",
       x = "fraction",
       y = "Air Volume in Primary Tumor")

```


```{r}

df_cbctfate
df_clinical_opc

# Find common patients
common_patients <- intersect(df_airvolume$patient, df_clinical_opc$patient)
# Count common patients
common_count <- length(common_patients)
common_count


```

```{r}

df_cbctvolume <- df_cbctvolume %>% filter(rt_fractions == 35)

df_cbctvolume %>%
  filter(Roi == 'x_GTVp_Tracking') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Volume of Primary Tumor over the course of treatment for all patients",
       x = "fraction",
       y = "Volume of Primary Tumor")

# REMOVE OUTLIER PATIENT
patients_to_remove <- df_cbctvolume %>%
  filter(fraction == 10 & percent_vol < -50) %>%
  pull(patient)

df_cbctvolume <- df_cbctvolume %>%
  filter(!patient %in% patients_to_remove)

df_cbctvolume %>%
  filter(Roi == 'x_Air_GTVp_Expanded05') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Air Volume in Primary Tumor over course of treatment for all patients",
       x = "fraction",
       y = "Air Volume in Primary Tumor")



```


```{r}

df_hpvseq <- df_hpvseq %>% mutate(timepoint = recode(timepoint,
                            "Baseline" = "baseline",
                            "Early RT" = "early",
                            "Mid RT" = "mid",
                            "3 months" = "followup"))
df_hpvseq_dates <- inner_join(df_hpvseq, df_ctdna_collectiondates_long, by = c("patient", "timepoint")) %>% rename(date = date_ctdna)
df_cbct_dates <- df_cbctvolume %>% mutate(date = as.Date(ExamDate)) %>% filter(Roi == "x_GTVp_Tracking")

```


```{r}
# Find common patients
common_patients <- intersect(df_hpvseq_dates$patient, df_cbct_dates$patient)
# Count common patients
common_count <- length(common_patients)

# Find unique patients in each data frame
unique_hpvseq_patients <- setdiff(df_hpvseq_dates$patient, df_cbct_dates$patient)
unique_cbct_patients <- setdiff(df_cbct_dates$patient, df_hpvseq_dates$patient)

# Count unique patients in each data frame
unique_hpvseq_count <- length(unique_hpvseq_patients)
unique_cbct_count <- length(unique_cbct_patients)

# Print the counts
common_count
unique_hpvseq_count
unique_cbct_count
```


```{r}
# Filter df_hpvseq_dates to only include patients that exist in df_cbct_dates
df_hpvseq_dates <- df_hpvseq_dates %>%
  semi_join(df_cbct_dates, by = "patient")

# Function to find the closest fraction date for each patient and timepoint
find_closest_fraction <- function(patient, hpv_date) {
  patient_cbct_dates <- df_cbct_dates %>% filter(patient == !!patient)
  if (nrow(patient_cbct_dates) == 0) return(NA)
  patient_cbct_dates <- patient_cbct_dates %>% mutate(date_diff = abs(difftime(date, hpv_date, units = "days")))
  closest_fraction <- patient_cbct_dates %>% filter(date_diff == min(date_diff)) %>% select(fraction) %>% slice(1)
  return(closest_fraction$fraction)
}

# Apply the function to each row in df_hpvseq_dates
df_hpvseq_dates <- df_hpvseq_dates %>%
  rowwise() %>%
  mutate(fraction = find_closest_fraction(patient, date))

# Modify the fraction column based on the timepoint
df_hpvseq_dates <- df_hpvseq_dates %>%
  mutate(fraction = ifelse(timepoint == "followup", 40, fraction))

# Display the updated dataframe
print(df_hpvseq_dates)
```

```{r}

# Create the plot
ggplot(df_hpvseq_dates, aes(x = fraction, y = seq_copies_mL, group = patient)) +
  geom_line(size=0.2, color='gray60',na.rm = TRUE) + 
  geom_point(aes(color = timepoint), size = 1) +
  scale_color_manual(values = c(
    "baseline" = "#0072B2",
    "early" = "#D55E00",
    "mid" = "#CC79A7",
    "followup" = "#009E73"
  )) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks(n = 10)
  ) +
  labs(
    title = "HPV ctDNA Concentration over the course of treatment for all patients",
    x = "Fraction",
    y = "HPV ctDNA Concentration (log scale)"
  ) + 
  theme_minimal() +
  theme(
  panel.background = element_blank(),  # Remove panel background
  plot.background = element_blank(),   # Remove plot background
  legend.background = element_blank(), # Remove legend background
  panel.grid.major = element_line(color = "grey95"), # Major grid lines
  panel.grid.minor = element_line(color = "grey96")  # Minor grid lines
  )

```
