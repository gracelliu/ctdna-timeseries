---
title: "patient_timeseries_eqd2.rmd"
author: "Grace Liu"
date: "2024-07-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r load, include=FALSE}

library(data.table)
library(dplyr)
library(patchwork)
library(faraway)
library(ggExtra)
library(GGally)
library(ggsci)
library(ggplot2)
library(ggpubr)
library(ggthemr)
library(gridExtra)
library(gt)
library(gtsummary)
library(rlang)
library(scales)
library(survival)
library(survminer)
library(readxl)
library(reshape2)
library(tidyverse)
library(rmdformats)
library(prettydoc)
library(hrbrthemes)
library(tint)
library(tufte)
library(cowplot)

ggthemr("fresh")

load("/Users/graceliu/bratman/timeseries/data/2024-06-21_head-neck-dataframes.Rdata")
load('/Users/graceliu/bratman/timeseries/data/HPV_analysis_dataframes.Rdata')

```



```{r preprocessing, echo=FALSE}

df_patient_timeseries_eqd2 <- merge(
  df_ctdna_eqd2_radiomic_clinical %>% select(patient, timepoint, EQD2, gtv_primary, sum_gtv_nodes),
  df_hpvseq %>% select(patient, timepoint, seq_copies_mL),
  by = c("patient", "timepoint")) %>%
  # filter(timepoint != "3 months") %>%
  mutate(log_seq_copies_mL = log1p(seq_copies_mL))

df_airvolume = merge(df_cbctfate_smooth, df_clinical_opc, by="Mrn")

```


```{r HN2976, echo=FALSE}

# HPV ctDNA concentration 
ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = seq_copies_mL)) +
  geom_point() +
  geom_line() +
  labs(title = "seq_copies_mL vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "seq_copies_mL")

# HPV ctDNA concentration LOG 
ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = log_seq_copies_mL)) +
  geom_point() +
  geom_line() +
  labs(title = "log_seq_copies_mL vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "log_seq_copies_mL ")

# Volume of primary
p1 <- ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = gtv_primary)) +
  geom_line() +
  labs(title = "gtv_primary vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "gtv_primary")

# Volume of nodes
p2 <- ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = sum_gtv_nodes)) +
  geom_line() +
  labs(title = "Volumes vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "sum_gtv_nodes")

# Volume of air 
p3 <- ggplot(df_airvolume %>% filter(patient == "HN2976" & Roi =="x_Air_GTVp_Expanded05"), aes(x = fraction, y = smoothed_normalized)) + 
  geom_line() + 
  labs(title = "Volumes vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "sum_gtv_nodes")

# Overlaid as one graph (using cowplot)
ggdraw() +
  draw_plot(p1) +
  draw_plot(p2) +
  draw_plot(p3)

```


```{r}
df_cbctfate %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line() +
  facet_wrap(~Roi)

df_cbctfate %>%
  filter(Roi == 'x_GTVp_Tracking') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line() 



df_cbctfate %>%
  filter(Roi == 'x_GTVp_Tracking', cohort == 'OPC') %>%
  group_by(Mrn) %>%
  filter(fraction == max(fraction)) %>%
  ungroup() %>%
  arrange(percent_vol) %>%
  mutate(group = if_else(percent_vol < median(percent_vol), 'Below median', 'Above median'))


df_ctdna_collectiondates %>% 
  rename(Baseline = date_ctdna_baseline) %>% 
  gather(timepoint, date_ctdna, -patient) %>% 
  left_join(df_cbctfate, by = c('date_ctdna' = 'ExamDate'))
```




```{r}

df_ctdna_collectiondates %>% rename(baseline = date_ctdna_baseline,
                                    early = date_ctdna_early, 
                                    mid = date_ctdna_mid,
                                    followup = date_ctdna_followup) %>%
  gather(timepoint, date_ctdna, -patient)


left_join(df_cbctfate, by = c('date_ctdna' = 'ExamDate'))


df_ctdna_collectiondates %>% rename(Baseline = date_ctdna_baseline) %>% gather(timepoint, date_ctdna, -patient) %>% left_join(df_cbctfate %>% mutate(ExamDate = as.date(ExamDate)), by = c('date_ctdna' = 'ExamDate'))

```















