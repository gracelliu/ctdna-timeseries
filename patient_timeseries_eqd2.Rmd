---
title: "patient_timeseries_eqd2.rmd"
author: "Grace Liu"
date: "2024-07-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r load, include=FALSE}

library(data.table)
library(dplyr)
library(patchwork)
library(faraway)
library(ggExtra)
library(GGally)
library(ggsci)
library(ggplot2)
library(ggpubr)
library(ggthemr)
library(gridExtra)
library(gt)
library(gtsummary)
library(rlang)
library(scales)
library(survival)
library(survminer)
library(readxl)
library(reshape2)
library(tidyverse)
library(rmdformats)
library(prettydoc)
library(hrbrthemes)
library(tint)
library(tufte)
library(cowplot)
library(grid)

ggthemr("fresh")

load("/Users/graceliu/bratman/timeseries/data/2024-06-21_head-neck-dataframes.Rdata")
load('/Users/graceliu/bratman/timeseries/data/HPV_analysis_dataframes.Rdata')

```



```{r preprocessing, echo=FALSE}

df_patient_timeseries_eqd2 <- merge(
  df_ctdna_eqd2_radiomic_clinical %>% select(patient, timepoint, EQD2, gtv_primary, sum_gtv_nodes),
  df_hpvseq %>% select(patient, timepoint, seq_copies_mL),
  by = c("patient", "timepoint")) %>%
  # filter(timepoint != "3 months") %>%
  mutate(log_seq_copies_mL = log1p(seq_copies_mL))

df_airvolume = merge(df_cbctfate_smooth, df_clinical_opc, by="Mrn")

```


```{r HN2976, echo=FALSE}

# HPV ctDNA concentration 
ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = seq_copies_mL)) +
  geom_point() +
  geom_line() +
  labs(title = "seq_copies_mL vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "seq_copies_mL")

# HPV ctDNA concentration LOG 
ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = log_seq_copies_mL)) +
  geom_point() +
  geom_line() +
  labs(title = "log_seq_copies_mL vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "log_seq_copies_mL ")

# Volume of primary
p1 <- ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = gtv_primary)) +
  geom_line() +
  labs(title = "gtv_primary vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "gtv_primary")

# Volume of nodes
p2 <- ggplot(df_patient_timeseries_eqd2 %>% filter(patient == "HN2976"), aes(x = EQD2, y = sum_gtv_nodes)) +
  geom_line() +
  labs(title = "Volumes vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "sum_gtv_nodes")

# Volume of air 
p3 <- ggplot(df_airvolume %>% filter(patient == "HN2976" & Roi =="x_Air_GTVp_Expanded05"), aes(x = fraction, y = smoothed_normalized)) + 
  geom_line() + 
  labs(title = "Volumes vs EQD2 for Patient HN2976",
       x = "EQD2",
       y = "sum_gtv_nodes")

# Overlaid as one graph (using cowplot)
ggdraw() +
  draw_plot(p1) +
  draw_plot(p2) +
  draw_plot(p3)

```


```{r}
df_cbctfate %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line(size=0.1) +
  facet_wrap(~Roi)

df_cbctfate %>%
  filter(Roi == 'x_GTVp_Tracking') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line() 


df_cbctfate %>%
  filter(Roi == 'x_GTVp_Tracking', cohort == 'OPC') %>%
  group_by(Mrn) %>%
  filter(fraction == max(fraction)) %>%
  ungroup() %>%
  arrange(percent_vol) %>%
  mutate(group = if_else(percent_vol < median(percent_vol), 'Below median', 'Above median'))


df_ctdna_collectiondates %>% 
  rename(Baseline = date_ctdna_baseline) %>% 
  gather(timepoint, date_ctdna, -patient) %>% 
  left_join(df_cbctfate, by = c('date_ctdna' = 'ExamDate'))
```



```{r}

df_ctdna_collectiondates_long <- df_ctdna_collectiondates %>% rename(baseline = date_ctdna_baseline,
                                    early = date_ctdna_early, 
                                    mid = date_ctdna_mid,
                                    followup = date_ctdna_followup) %>%
  gather(timepoint, date_ctdna, -patient)

```



```{r}

# Find common patients between df_hpvseq and df_ctdna_collectiondates
common_patients <- intersect(df_hpvseq$patient, df_ctdna_collectiondates$patient)
# Count common patients
common_count <- length(common_patients)

# Find patients only in df_hpvseq
only_in_hpvseq <- setdiff(df_hpvseq$patient, df_ctdna_collectiondates$patient)
# Count patients only in df_hpvseq
only_in_hpvseq_count <- length(only_in_hpvseq)

# Find patients only in df_ctdna_collectiondates
only_in_ctdna_collection_dates <- setdiff(df_ctdna_collectiondates$patient, df_hpvseq$patient)
# Count patients only in df_ctdna_collectiondates
only_in_ctdna_collection_dates_count <- length(only_in_ctdna_collection_dates)

# Display results
common_count
only_in_hpvseq_count
only_in_ctdna_collection_dates_count

```


```{r}

df_cbctvolume = inner_join(df_cbctfate, df_clinical_opc, by="Mrn")
unique(df_cbctvolume$cohort)
unique(df_cbctvolume$Roi)
unique(df_cbctvolume$series_index)


```

```{r}

# Find patients only in df_hpvseq
only_in_hpvseq <- setdiff(df_hpvseq$patient, df_cbctvolume$patient)
# Count patients only in df_hpvseq
only_in_hpvseq_count <- length(only_in_hpvseq)

# Find patients only in df_cbctvolume
only_in_cbctvolume <- setdiff(df_cbctvolume$patient, df_hpvseq$patient)
# Count patients only in df_cbctvolume
only_in_cbctvolume_count <- length(only_in_cbctvolume)

# Display the results
common_count
only_in_hpvseq_count
only_in_cbctvolume_count

```




```{r}

df_cbctfate %>%
  ggplot(aes(x = fraction, y = percent_vol, group = Mrn)) +
  geom_line(size=0.1) +
  facet_wrap(~Roi)

df_cbctvolume %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.1) +
  facet_wrap(~Roi)

```


```{r}

# All patients air volume and tumor volume 

df_cbctvolume %>%
  filter(Roi == 'x_GTVp_Tracking') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Volume of Primary Tumor over the course of treatment for all patients",
       x = "fraction",
       y = "Volume of Primary Tumor")

df_cbctvolume %>%
  filter(Roi == 'x_Air_GTVp_Expanded05') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Air Volume in Primary Tumor over course of treatment for all patients",
       x = "fraction",
       y = "Air Volume in Primary Tumor")

```


```{r}

df_cbctfate
df_clinical_opc

# Find common patients
common_patients <- intersect(df_airvolume$patient, df_clinical_opc$patient)
# Count common patients
common_count <- length(common_patients)
common_count


```

```{r}

# tumor volume
df_cbctvolume <- df_cbctvolume %>% filter(rt_fractions == 35)

df_cbctvolume %>%
  filter(Roi == 'x_GTVp_Tracking') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Volume of Primary Tumor over the course of treatment for all patients",
       x = "fraction",
       y = "Volume of Primary Tumor")


# air volume 

# remove outlier patient 
patients_to_remove <- df_cbctvolume %>%
  filter(fraction == 10 & percent_vol < -50) %>%
  pull(patient)

df_cbctvolume <- df_cbctvolume %>%
  filter(!patient %in% patients_to_remove)

df_cbctvolume %>%
  filter(Roi == 'x_Air_GTVp_Expanded05') %>%
  ggplot(aes(x = fraction, y = percent_vol, group = patient)) +
  geom_line(size=0.2) +
  labs(title = "Air Volume in Primary Tumor over course of treatment for all patients",
       x = "fraction",
       y = "Air Volume in Primary Tumor")



```


```{r}

df_hpvseq <- df_hpvseq %>% mutate(timepoint = recode(timepoint,
                            "Baseline" = "baseline",
                            "Early RT" = "early",
                            "Mid RT" = "mid",
                            "3 months" = "followup"))
df_hpvseq_dates <- inner_join(df_hpvseq, df_ctdna_collectiondates_long, by = c("patient", "timepoint")) %>% rename(date = date_ctdna)
df_cbct_dates <- df_cbctvolume %>% mutate(date = as.Date(ExamDate)) %>% filter(Roi == "x_GTVp_Tracking")

```


```{r}
# Find common patients
common_patients <- intersect(df_hpvseq_dates$patient, df_cbct_dates$patient)
# Count common patients
common_count <- length(common_patients)

# Find unique patients in each data frame
unique_hpvseq_patients <- setdiff(df_hpvseq_dates$patient, df_cbct_dates$patient)
unique_cbct_patients <- setdiff(df_cbct_dates$patient, df_hpvseq_dates$patient)

# Count unique patients in each data frame
unique_hpvseq_count <- length(unique_hpvseq_patients)
unique_cbct_count <- length(unique_cbct_patients)

# Print the counts
common_count
unique_hpvseq_count
unique_cbct_count
```


```{r}
# Filter df_hpvseq_dates to only include patients that exist in df_cbct_dates
df_hpvseq_dates <- df_hpvseq_dates %>%
  semi_join(df_cbct_dates, by = "patient")

# Function to find the closest fraction date for each patient and timepoint
find_closest_fraction <- function(patient, hpv_date) {
  patient_cbct_dates <- df_cbct_dates %>% filter(patient == !!patient)
  if (nrow(patient_cbct_dates) == 0) return(NA)
  patient_cbct_dates <- patient_cbct_dates %>% mutate(date_diff = abs(difftime(date, hpv_date, units = "days")))
  closest_fraction <- patient_cbct_dates %>% filter(date_diff == min(date_diff)) %>% select(fraction) %>% slice(1)
  return(closest_fraction$fraction)
}

# Apply the function to each row in df_hpvseq_dates
df_hpvseq_dates <- df_hpvseq_dates %>%
  rowwise() %>%
  mutate(fraction = find_closest_fraction(patient, date))

# Modify the fraction column based on the timepoint
df_hpvseq_dates <- df_hpvseq_dates %>%
  mutate(fraction = ifelse(timepoint == "followup", 40, fraction))

# Display the updated dataframe
print(df_hpvseq_dates)
```

```{r}

df_hpvseq_dates$seq_copies_mL_log <- log1p(df_hpvseq_dates$seq_copies_mL)

# Calculate percent change from baseline for each patient
df_hpvseq_dates <- df_hpvseq_dates %>%
  group_by(patient) %>%
  arrange(fraction) %>%  # Ensure data is sorted by fraction within each patient group
  mutate(
    baseline_seq_log = first(seq_copies_mL_log, order_by = fraction),  # Get the first value as baseline
    percent_hpvseq = (seq_copies_mL_log - baseline_seq_log) / baseline_seq_log * 100
  ) %>%
  ungroup() %>%
  select(-baseline_seq_log)  # Remove the temporary baseline column


# Create log ctDNA plot
ggplot(df_hpvseq_dates, aes(x = fraction, y = seq_copies_mL_log, group = patient)) +
  geom_line(size=0.1, color='gray30',na.rm = TRUE) + 
  geom_point(aes(color = timepoint), size = 1) +
  scale_color_manual(values = c(
    "baseline" = "#0072B2",
    "early" = "#D55E00",
    "mid" = "#CC79A7",
    "followup" = "#009E73"
  )) +
  scale_x_continuous(
    breaks = scales::pretty_breaks(n = 10)
  ) +
  labs(
    title = "HPV ctDNA Concentration over treatment",
    x = "Fraction",
    y = "HPV ctDNA Concentration (log scale)"
  ) 

# Create % change ctDNA plot
ggplot(df_hpvseq_dates, aes(x = fraction, y = percent_hpvseq, group = patient)) +
  geom_line(size=0.1, color='gray30',na.rm = TRUE) + 
  geom_point(aes(color = timepoint), size = 1) +
  scale_color_manual(values = c(
    "baseline" = "#0072B2",
    "early" = "#D55E00",
    "mid" = "#CC79A7",
    "followup" = "#009E73"
  )) +
  scale_x_continuous(
    breaks = scales::pretty_breaks(n = 10)
  ) +
  labs(
    title = "% change in HPV ctDNA Concentration over treatment",
    x = "Fraction",
    y = "% change in ctDNA"
  ) 

```


```{r}

# Filter patients that are in both datasets
shared_patients <- intersect(df_cbctvolume$patient, df_hpvseq_dates$patient)

df_cbctvolume_shared <- df_cbctvolume %>%
  filter(patient %in% shared_patients)

df_hpvseq_dates_shared <- df_hpvseq_dates %>%
  filter(patient %in% shared_patients)

# Function to create plots for each patient
create_patient_plot <- function(patient_id) {
  # Tumor volume plot
  tumor_volume_plot <- df_cbctvolume_shared %>%
    filter(patient == patient_id, Roi == 'x_GTVp_Tracking') %>%
    ggplot(aes(x = fraction, y = percent_vol)) +
    geom_line(size=1, color='#4AAFD5') +
    scale_x_continuous(limits = c(1, 40)) +
    labs(x = "Fraction",
         y = "% Change of Tumor Volume") 

  # Air volume plot
  air_volume_plot <- df_cbctvolume_shared %>%
    filter(patient == patient_id, Roi == 'x_Air_GTVp_Expanded05') %>%
    ggplot(aes(x = fraction, y = percent_vol)) +
    geom_line(size=1, color='#91B187') +
    scale_x_continuous(limits = c(1, 40)) +
    labs(x = "Fraction",
         y = "% Change of Air Volume") 

  # ctDNA concentration plot
  ctdna_plot <- df_hpvseq_dates_shared %>%
    filter(patient == patient_id) %>%
    ggplot(aes(x = fraction, y = percent_hpvseq, group = patient)) +
    geom_line(size=1, color='#E7A339', na.rm = TRUE) + 
    geom_point(size = 1, color="black") +
    scale_x_continuous(limits = c(1, 40), breaks = scales::pretty_breaks(n = 10)) +
    labs(x = "Fraction",
         y = "% Change of HPV ctDNA") 

  # Create labels for the side
  label_gtv <- ggdraw() + draw_label("GTV", x = 0.5, y = 0.5, angle = 90, hjust = 0.5, vjust = 0, size = 30, fontface = "bold")
  label_fate <- ggdraw() + draw_label("FATE", x = 0.5, y = 0.5, angle = 90, hjust = 0.5, vjust = 0, size = 30, fontface = "bold")
  label_ctdna <- ggdraw() + draw_label("ctDNA", x = 0.5, y = 0.5, angle = 90, hjust = 0.5, vjust = 0, size = 30, fontface = "bold")

  # Combine plots and labels using cowplot
  combined_plot <- plot_grid(
    plot_grid(label_gtv, label_fate, label_ctdna, ncol = 1),
    plot_grid(tumor_volume_plot, air_volume_plot, ctdna_plot, ncol = 1, align = "v"),
    ncol = 2, rel_widths = c(0.1, 1)
  ) +
    ggtitle(paste("Patient ID:", patient_id)) +
    theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))

  return(combined_plot)
}

# Create and save plot for a single patient
test_patient_id <- shared_patients[1]  # Change this to test different patient IDs
patient_plot <- create_patient_plot(test_patient_id)

# Save the plot in the ../results directory
plot_filename <- paste0("../results/patient_plot_", test_patient_id, ".png")
ggsave(filename = plot_filename, plot = patient_plot, width = 8, height = 10)


```



